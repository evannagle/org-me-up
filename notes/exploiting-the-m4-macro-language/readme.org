#+TITLE: Exploiting the m4 Macro Language
#+AUTHOR: Kenneth J. Turner
#+DATE: 1994
#+EMAIL: evan@mantle.co
#+CREATOR: Evan Nagle
#+TAGS: @bab @pdf

* Commands

|--------------------------------------+-----------------------------------------------------------------------|
| Command                              | Description                                                           |
|--------------------------------------+-----------------------------------------------------------------------|
| #                                    | Comment line                                                          |
| changequote(l,r)                     | Change the default `' escape sequence                                 |
| define(name,val)                     | Define macro name to val                                              |
| divert(stream_number)                | Divert future output to stream_number                                 |
| divnum                               | Expand to currently active diversion number                           |
| dnl                                  | Delete up to new line. Used at the end of a line to omit blank spaces |
| dumpdef(name,...)                    | Print variable definition                                             |
| errprint(message,..)                 | Print one or more message to standard error output                    |
| eval(expression)                     | Expand to result of numeric expression                                |
| ifdef(name,def_text,undef_text)      | If macro is defined, expand to def_text, otherwise undef_text         |
| ifelse(text1,text2,eq_text,neq_text) | If text1 == text2, expand to eq_text, otherwise neq_text              |
| include(file_name)                   | Expand to contents of file_name                                       |
| incr(number)                         | Expand to number + 1                                                  |
| index(string1, string2)              | Expand to index in string1 where string2 occurs                       |
| len(string)                          | Expand to length of string                                            |
| maketemp(...XXXXXX...)               | Expand to temporary filename, replacing X's with a process id         |
| sinclude(file_name)                  | Expand to contents of file_name, without complaint if nonexistant     |
| substr(string,position,number)       | Expand to string from position (0 is start) for number of chars       |
| translit(string,from,to)             | Expand to string with from chars replaced with to chars               |
| undefine(`name')                     | Delete definition of name                                             |
| undivert(stream_number,...)          | Retrieve text from diversion stream_number                            |
|--------------------------------------+-----------------------------------------------------------------------|

* Expansion

** Variables act somewhat like reference variables

#+BEGIN_SRC sh
m4 <<<'dnl
changequote({,})dnl
define(Operator,Plus)dnl
define(Operator,+)dnl
Plus'
#+END_SRC

#+RESULTS:
: +



** Parameterization

#+BEGIN_SRC sh :results scalar
m4 <<<"dnl
define(op,plus)dnl
define(op,+)dnl
define(Average,\`eval((\$1 plus \$2)/2)')dnl
Average(5,10)
Average(12,82)
Average(100,200)dnl
"
#+END_SRC

#+RESULTS:
: 7
: 47
: 150

* Use of Files

#+BEGIN_SRC sh :results scalar
m4 <<<"include(data/print.m4)

Now nothing gets output
Until I
Print(this line)
Print(and this one)
"
#+END_SRC

#+RESULTS:
: this line 
: and this one 

#+BEGIN_SRC sh :results scalar
m4 <<<"dnl
include(data/print.m4)
include(data/maths.m4)

Print(
Add(1,2)
Mult(3,21)
Avg(1,4))
"
#+END_SRC

#+RESULTS:
: 3
: 63
: 2 

* Quoting

#+BEGIN_SRC sh :results scalar
m4 <<<"dnl
include(data/print.m4)

define(Macro1,\$1\`,' )dnl
define(Macro2,\`Macro1(hello)\$1')

Print(\`Macro2(world)')
"
#+END_SRC

#+RESULTS:
: hello, world 

* Controlling Whitespace with divert()

#+BEGIN_SRC sh :results scalar
m4 <<<"divert(-1)


None of this will print


divert()dnl
But this will
And this will"

#+END_SRC

#+RESULTS:
: But this will
: And this will

* Conditionals
** ifelse
#+BEGIN_SRC sh
m4 <<<"
ifelse(a,a,equal,not)
ifelse(a,b,equal,not)
ifelse(a,b,equal)
ifelse(a,a,,not)
ifelse(a,a,equal)
"
#+END_SRC

#+RESULTS:
|       |
| equal |
| not   |
|       |
|       |
| equal |
|       |

** 

#+BEGIN_SRC sh :results scalar
m4 <<<"dnl
include(data/print.m4)
include(data/if.m4)

define(Debugging)
Debug(\`Simpler than ifelse')
Debug(\`--')
PrintStream
Is 1 > 0?
Answer: dnl()
If(\`1>0',
  \`Yes',
  \`No')
EndPrintStream
"
#+END_SRC

#+RESULTS:
: Simpler than ifelse 
: -- 
: Is 1 > 0?
: Answer: Yes

* Recording Definitions

#+BEGIN_SRC sh :results scalar
m4 <<<"divert(-1)
define(Macro1,\`define(\`Macro1Fired')')
divert()dnl
ifdef(\`Macro1Fired',fired,not fired)
Macro1()dnl
ifdef(\`Macro1Fired',fired,not fired)
"
#+END_SRC

#+RESULTS:
: not fired
: fired
: 

* Higher-Order Macros: Pseudo Lambdas

#+BEGIN_SRC sh
m4 <<<"divert(-1)
include(data/maths.m4)
define(Call,\$1(\$2,\$3,\$4))
divert()dnl
Call(\`Add',1,2)
"
#+END_SRC

#+RESULTS:
: 3

* Curried Macros

#+BEGIN_SRC sh :results scalar
m4 <<<"divert(-1)
changequote({,})

define(Times,{eval(\$1*\$2)})
define(Curry1,{define(\$1,{\$2}(\$3,\${}1))})

divert()dnl
Curry1(Times3,{Times},3)
Times3(5)
Times(3,5)
"
#+END_SRC

#+RESULTS:
: 
: 15
: 15
: 

* Recursion
** Factorial
#+BEGIN_SRC sh :results scalar
m4 <<<"divert(-1)
changequote({,})

# Factorial function
define(Fact,{ifelse(eval(\$1 <= 1),1,
    1,
    {eval(\$1*Fact(decr(\$1)))})
})

divert(0)dnl
Fact(10)
"
#+END_SRC

#+RESULTS:
: 3628800
: 
: 

** Factorial with Auxillary Accumulator

#+BEGIN_SRC sh
m4 <<<"divert(-1)
changequote({,})

define(Fact, {FactAux(\$1,1)})

# Auxillary Function with Accumulator
define(FactAux,\$1 \$2
{ifelse(eval(\$1<=1),1,
  \$2, 
  {FactAux(decr(\$1),eval(\$1*\$2))})})

divert(0)dnl
Fact(10)"
#+END_SRC

#+RESULTS:
|      10 |       1 |
|       9 |      10 |
|       8 |      90 |
|       7 |     720 |
|       6 |    5040 |
|       5 |   30240 |
|       4 |  151200 |
|       3 |  604800 |
|       2 | 1814400 |
|       1 | 3628800 |
| 3628800 |         |

** Fibonacci

#+BEGIN_SRC sh
m4 <<<"divert(-1)
changequote({,})
define(Fib,
  {ifelse(eval(\$1<=1),1,
    \$2,
    {ifelse(eval(\$1==2),1,
      \$3,
      {eval(Fib(decr(decr(\$1)),\$2,\$3)+Fib(decr(\$1),\$2,\$3))})})})
divert(0)dnl
Fib(17,1,1)
"
#+END_SRC

#+RESULTS:
: 1597

** Flip/Flop

#+BEGIN_SRC sh :results scalar
m4 <<<"divert(-1)
changequote({,})
define(Flip,{ifelse(eval(\$1>=0),1,{On Flop(decr(\$1))})})
define(Flop,{ifelse(eval(\$1>=0),1,{Off Flip(decr(\$1))})})
divert(0)dnl
Flip(5)
Flop(4)
"
#+END_SRC

#+RESULTS:
: On Off On Off On Off 
: Off On Off On Off 
: 

* Side-Effects

#+BEGIN_SRC sh :results scalar
m4 <<<"divert(-1)

changequote({,})
define(Called_List)
define(Call_Text,{Call of \$1
})
define(Called,{define({Called_List},Called_List {Call_Text(\$1)})})
Called(1)
Called(2)
Called(3)
divert(0)dnl

Called_List"
#+END_SRC

#+RESULTS:
: 
:  Call of 1
:  Call of 2
:  Call of 3
: 

#+BEGIN_SRC sh
m4 <<<"divert(-1)

changequote({,})

define({push},{
  define({\$1},ifdef({\$1},\$1 \$2,\$2))
})
push({a},1)
push({a},2)
push({a},3)
push({b},4 5 6)
divert()dnl
a
b
"
#+END_SRC

#+RESULTS:
| 1 | 2 | 3 |
| 4 | 5 | 6 |
|   |   |   |

* Iteration
** For Loop
#+BEGIN_SRC sh :results scalar
m4 <<<"divert(-1)

changequote({,})

define(\,{dnl})
define(HIDE,{divert(-1)})
define(SHOW,{divert(0)dnl})

define(loop, {\
HIDE
   ifelse(\$2,0,,{
     define({\$1},\$2)
SHOW
\$3
HIDE
     loop({\$1},decr(\$2),{\$3})\
   })
})
SHOW
loop({i},10,{Counter is i})
"
#+END_SRC

#+RESULTS:
#+begin_example
Counter is 10
Counter is 9
Counter is 8
Counter is 7
Counter is 6
Counter is 5
Counter is 4
Counter is 3
Counter is 2
Counter is 1
#+end_example

** While Loop

#+BEGIN_SRC sh :results scalar
m4 <<<"divert(-1)
changequote({,})

define(print,{divert(0){\$*}
divert(-1)})

define(while, {
  ifelse(eval(\$1),1,{
    print(\$2)
    while({\$1},{\$2})
  })
})

define(i,10)
while({i>0},{Counter is i} {define({i},decr(i))})
"
#+END_SRC

#+RESULTS:
#+begin_example
Counter is 10 
Counter is 9 
Counter is 8 
Counter is 7 
Counter is 6 
Counter is 5 
Counter is 4 
Counter is 3 
Counter is 2 
Counter is 1 
#+end_example

* List Manipulation
** Cons

#+BEGIN_SRC sh 
m4 <<<"dnl()
include(data/print.m4)
include(data/lists.m4)

define(\`listA',Cons(abc,[def;ghij]))
define(\`listA',Cons(012,listA))

Print(listA)
"
#+END_SRC

#+RESULTS:
: [012;abc;def;ghij]

** HeadEnd

#+BEGIN_SRC sh
m4 <<<"dnl()
include(data/print.m4)
include(data/lists.m4)

define(listA,[abcd;efg;hij])

Print(HeadEnd(listA))
"
#+END_SRC

#+RESULTS:
: 4

** Head

#+BEGIN_SRC sh
m4 <<<"dnl
include(data/print.m4)
include(data/lists.m4)

define(\`a',[1;2;3;4])
Print(Head(a))
"
#+END_SRC

#+RESULTS:
: 1

** Tail

#+BEGIN_SRC sh
m4 <<<"dnl
include(data/print.m4)
include(data/lists.m4)

define(\`a',[ab[m]c00;def;ghij])
Print(Tail(a))
"
#+END_SRC

#+RESULTS:
: [def;ghij]

** Concat

#+BEGIN_SRC sh
m4 <<<"dnl
include(data/print.m4)
include(data/lists.m4)

define(a,Concat([abc;def],[ghi;1234]))
Print(a)
"
#+END_SRC

#+RESULTS:
: [abc;def;ghi;1234]

** Length

#+BEGIN_SRC sh
m4 <<<"dnl
include(data/print.m4)
include(data/lists.m4)

define(a,[abcd;efg;hij;mno])
Print(Length(a))
"
#+END_SRC

#+RESULTS:
: 4

** Reverse

#+BEGIN_SRC sh
m4 <<<"dnl
include(data/print.m4)
include(data/lists.m4)

define(\`a',[abc;def;ghi])
define(\`a',Reverse(a))
Print(a)
"
#+END_SRC

#+RESULTS:
: [ghi;def;abc]

** AppList

#+BEGIN_SRC sh
m4 <<<"dnl
include(data/print.m4)
include(data/lists.m4)

define(numbers,[1;2;3;4])
define(numbers2, AppList(\`incr',numbers))

Print(numbers2)"

#+END_SRC

#+RESULTS:
: 2345

** MapList

#+BEGIN_SRC sh :results scalar
m4 <<<"dnl
include(data/print.m4)
include(data/lists.m4)

define(\`list',[1;2;3;4])
Print(list)

define(\`list',MapList(\`incr',list))
Print(list)
"
#+END_SRC

#+RESULTS:
: [1;2;3;4] 
: [2;3;4;5] 

