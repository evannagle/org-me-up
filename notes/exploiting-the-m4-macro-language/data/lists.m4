# Cons(abc,[def;ghij]) => [abc;def;ghij]
# Param 1 = string
# Param 2 = list, e.g. [abcd;efg;hij]
define(`Cons',
  `ifelse($2,[],
    [$1],
    [$1;`substr($2,1)')')

# HeadEndAux([abc;def;ghij],1,0) => 3
# Param 1 = list
# Param 2 = char index
# Param 3 = quote depth, default 0
define(`HeadEndAux',
  `define(`$0Char',
    substr($1,$2,1))dnl()
    ifelse($0Char,[,
      `HeadEndAux($1,incr($2),incr($3))',
      $0Char,],
        `ifelse($3,0,
	  decr($2),
	  `HeadEndAux($1,incr($2),decr($3))')',
      $0Char,;,
        `ifelse($3,0,
	  decr($2),
	  `dHeadEndAux($1,incr($2),$3)')',
      `HeadEndAux($1,incr($2),$3)')')

define(`HeadEnd',
  `HeadEndAux($1,1,0)')

# Head([abc;def;ghij]) => abc
define(`Head',
  `substr($1,1,HeadEnd($1))')
  
# Tail([abc;def;ghij]) => [def;ghij]
define(`Tail',
  `define(`$0Pos',HeadEnd($1))dnl
   define(`$0Len',len($1))dnl
   ifelse($0Pos,eval($0Len-2),
     [],
     `[substr($1,eval($0Pos+2),eval($0Len-$0Pos-3))]')')

# Concat([abc;def],[ghi;jkl]) => [abc;def;ghi;jkl]
define(`Concat',
  `ifelse($1,[],
    $2,
    $2,[],
      $1,
      `substr($1,0,decr(len($1)));substr($2,1,decr(len($2)))')')

# Length([abc;def;ghi]) = 3
define(`Length',`LengthAux($1,0)')

define(`LengthAux',
	`ifelse($1,[],
	  $2,
	  `LengthAux(Tail($1),incr($2))')')

# Reverse([abc;def;ghi]) = [ghi;def;abc]
define(`Reverse', `ReverseAux($1,[])')

define(`ReverseAux',
  `ifelse($1,[],
    $2,
    `ReverseAux(Tail($1),Cons(Head($1),$2))')')

# AppList(incr,[1;2;3]) = 234
define(`AppList',
  `ifelse($2,[],
    ,
    `$1(Head($2))'`AppList($1,Tail($2))')')


# MapList
define(`MapList',`MapListAux(`$1',$2,[)')

define(`MapListAux',
  `ifelse($2,[],
    $3],
    `ifelse($3,[,
      `MapListAux(`$1',Tail($2),$3$1(Head($2)))',
      `MapListAux(`$1',Tail($2),$3;$1(Head($2)))')')')
